function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],r=!0,a=!1,o=void 0;try{for(var i,c=e[Symbol.iterator]();!(r=(i=c.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==c.return||c.return()}finally{if(a)throw o}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function asyncGeneratorStep(e,t,n,r,a,o,i){try{var c=e[o](i),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(r,a)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){asyncGeneratorStep(o,r,a,i,c,"next",e)}function c(e){asyncGeneratorStep(o,r,a,i,c,"throw",e)}i(void 0)}))}}import"../../assets/icon-16.png";import"../../assets/icon-32.png";import"../../assets/icon-80.png";var textAttachment="",idURL=function(e){return"https://dev.azure.com/southbendin/_apis/wit/workitems?ids=".concat(e.val,"&api-version=6.0")},wiqlURL="https://dev.azure.com/southbendin/_apis/wit/wiql?api-version=6.0",ticketURL=function(e){return"https://dev.azure.com/southbendin/Applications%20-%20Project%20Portfolio/_apis/wit/workitems/$".concat(e.val,"?api-version=6.0")},updateAttachmentURL=function(e){return"https://dev.azure.com/southbendin/_apis/wit/workitems/".concat(e.val,"?api-version=6.0")},createAttachmentURL="https://dev.azure.com/southbendin/Applications%20-%20Project%20Portfolio/_apis/wit/attachments?fileName=EmailAsFileAttachment.txt&api-version=6.0";function createToken(){return _createToken.apply(this,arguments)}function _createToken(){return(_createToken=_asyncToGenerator(regeneratorRuntime.mark((function e(){var t,n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t={method:"POST",body:JSON.stringify({displayName:"new_token",scope:"app_token",validTo:"2022-12-01T23:46:23.319Z",allOrgs:!1})},e.next=3,fetch("https://vssps.dev.azure.com/{organization}/_apis/tokens/pats?api-version=6.1-preview.1",t);case 3:return n=e.sent,e.next=6,n.json();case 6:return r=e.sent,e.abrupt("return",r.patToken.token);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var paToken="Basic "+btoa("Basic:"+createToken()),queryWIQL='{\n  "query": "Select [System.Id], [System.Title], [System.State] From WorkItems Where [System.WorkItemType] = \'Maintenance\'"}',headersWIQL={method:"POST",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:paToken},body:queryWIQL},headersMaintenance={method:"GET",headers:{"Content-Type":"application/json",Authorization:paToken}};function concatIDs(e){var t="";return e.workItems.forEach((function(e){t+=e.id+","})),t.slice(0,-1)}function createDropdown(e){for(var t=new Map,n='<select id="parentItem" name="parentItem">',r=0;r<e.length;r++)t.set(e[r].id,e[r].fields["System.Title"]);new Map(_toConsumableArray(t).sort((function(e,t){return String(e[1]).localeCompare(t[1])}))).forEach((function(e,t){var r='<option value="'.concat(t,'">').concat(e," - Maintenance Item: ").concat(t,"</option>");n+=r})),n+="</select>",document.querySelector("#dropdown").innerHTML=n}function grabFormItems(){var e=document.getElementById("parentItem").value;return[document.getElementById("bug-ticket").checked?"Bug":"Task",e,document.getElementById("item-subject").value]}function createTicketHeader(e,t){var n,r;return{method:"POST",headers:{"Content-Type":"application/json-patch+json",Authorization:paToken},body:JSON.stringify((n={val:t},r={val:e},[{op:"add",path:"/fields/System.Title",from:null,value:"".concat(n.val)},{op:"add",path:"/relations/-",value:{rel:"System.LinkTypes.Hierarchy-Reverse",url:"https://dev.azure.com/southbendin/_apis/wit/workItems/".concat(r.val),attributes:{isLocked:!1,name:"Parent"}}}]))}}function createAttachmentHeader(e){var t;return{method:"POST",headers:{"Content-Type":"application/octet-stream",Authorization:paToken},body:(t={val:e},"".concat(t.val))}}function addAttachmentHeader(e){var t;return{method:"PATCH",headers:{"Content-Type":"application/json-patch+json",Authorization:paToken},body:JSON.stringify((t={val:e},[{op:"add",path:"/relations/-",value:{rel:"AttachedFile",url:"".concat(t.val),attributes:{comment:"Created with Outlook Azure add-in"}}}]))}}function getMaintenanceItems(){return _getMaintenanceItems.apply(this,arguments)}function _getMaintenanceItems(){return(_getMaintenanceItems=_asyncToGenerator(regeneratorRuntime.mark((function e(){var t,n,r,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch(wiqlURL,headersWIQL);case 2:return t=e.sent,e.next=5,t.json();case 5:return n=e.sent,r=concatIDs(n),e.next=9,fetch(idURL({val:r}),headersMaintenance);case 9:return a=e.sent,e.next=12,a.json();case 12:createDropdown(e.sent.value);case 14:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function createNewTicket(){return _createNewTicket.apply(this,arguments)}function _createNewTicket(){return(_createNewTicket=_asyncToGenerator(regeneratorRuntime.mark((function e(){var t,n,r,a,o,i,c,s,u,l;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=grabFormItems(),n=_slicedToArray(t,3),r=n[0],a=n[1],o=n[2],e.next=3,fetch(ticketURL({val:r}),createTicketHeader(a,o));case 3:return i=e.sent,e.next=6,i.json();case 6:return c=e.sent,e.next=9,fetch(createAttachmentURL,createAttachmentHeader(textAttachment));case 9:return s=e.sent,e.next=12,s.json();case 12:return u=e.sent,e.next=15,fetch(updateAttachmentURL({val:c.id}),addAttachmentHeader(u.url));case 15:return l=e.sent,e.next=18,l.json();case 18:e.sent,document.getElementById("app-body").innerHTML="<div>DevOps ticket ".concat(c.id,' has been created. View the ticket in DevOps <a href="https://dev.azure.com/southbendin/Applications%20-%20Project%20Portfolio/_workitems/edit/').concat(c.id,'">here</a></div>');case 20:case"end":return e.stop()}}),e)})))).apply(this,arguments)}Office.onReady((function(e){if(e.host===Office.HostType.Outlook){document.getElementById("sideload-msg").style.display="none",document.getElementById("app-body").style.display="flex",document.getElementById("run").onclick=run,getMaintenanceItems();var t=Office.context.mailbox.item,n=Office.context.mailbox.item.attachments;console.log(n),document.getElementById("item-subject").placeholder=t.subject,Office.context.mailbox.getCallbackTokenAsync({isRest:!0},(function(e){var t=Office.context.mailbox.item.itemId,n=e.value,r=t.replaceAll("/","-").replaceAll("+","_"),a=(Office.context.mailbox.restUrl||"https://outlook.office365.com/api")+"/v2.0/me/messages/"+r,o=new XMLHttpRequest;o.open("GET",a),o.setRequestHeader("Prefer",'outlook.body-content-type="text"'),o.setRequestHeader("Authorization","Bearer "+n),o.onload=function(e){var t=JSON.parse(o.responseText);textAttachment=t.Body.Content},o.send()}))}}));export function run(){return _run.apply(this,arguments)}function _run(){return(_run=_asyncToGenerator(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:createNewTicket();case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}